import { extensionAuthMiddleware } from '$lib/server/api/middleware/auth.middleware';
import { type RequestHandler } from '@sveltejs/kit';

export const GET: RequestHandler = async ({ request, locals: { api } }) =>
	extensionAuthMiddleware({ request, api }, async () => {
		const encoder = new TextEncoder();
		let closed = false;
		let interval: NodeJS.Timeout;

		const closeStream = () => {
			closed = true;
			clearInterval(interval);
			api.getLogService().info('Closed exporter event stream');
		};

		const stream = new ReadableStream({
			start(controller) {
				api.getLogService().info('Created exporter event stream');

				const unsubscribe = api.eventBus.subscribe((event) => {
					if (closed) return;

					controller.enqueue(
						encoder.encode(
							`id: ${event.id}\n` +
								`event: ${event.name}\n` +
								`data: ${JSON.stringify(event.payload ?? {})}\n\n`,
						),
					);
				});

				interval = setInterval(() => {
					if (closed) return;

					try {
						controller.enqueue(`: ping\n\n`);
					} catch {
						clearInterval(interval);
					}
				}, 15_000);

				request.signal.addEventListener('abort', () => {
					unsubscribe();
					closeStream();
				});
			},

			cancel() {
				closeStream();
			},
		});

		return new Response(stream, {
			headers: {
				'Content-Type': 'text/event-stream',
				'Cache-Control': 'no-cache',
				Connection: 'keep-alive',
			},
		});
	});
